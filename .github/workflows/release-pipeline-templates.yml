name: Release Pipeline Templates

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to update (e.g., azext-pt/v1)"
        required: true
        default: "azext-pt/v1"

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ inputs.branch }}';

            // Validate branch format
            if (!/^azext-pt\/v\d+$/.test(branch)) {
              core.setFailed(`Branch must match pattern azext-pt/vN (e.g., azext-pt/v1)`);
              return;
            }

            // Get main branch SHA
            const { data: mainRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });
            const mainSha = mainRef.object.sha;

            // Check if release branch exists
            let branchExists = true;
            let branchSha = null;
            try {
              const { data: branchRef } = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`
              });
              branchSha = branchRef.object.sha;
            } catch (e) {
              if (e.status === 404) {
                branchExists = false;
              } else {
                throw e;
              }
            }

            // Create branch if it doesn't exist
            if (!branchExists) {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branch}`,
                sha: mainSha
              });
              core.summary.addHeading('✅ Branch Created', 2);
              core.summary.addRaw(`**Branch:** \`${branch}\`\n\n`);
              core.summary.addRaw(`**Commit:** \`${mainSha}\`\n`);
              await core.summary.write();
              return;
            }

            // Check if already up to date
            if (mainSha === branchSha) {
              core.notice(`Branch ${branch} is already up to date with main`);
              core.summary.addHeading('ℹ️ No Changes', 2);
              core.summary.addRaw(`Branch \`${branch}\` is already at the same commit as \`main\`.\n`);
              await core.summary.write();
              return;
            }

            // Create PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: 'main',
              base: branch,
              title: `Release pipeline templates to ${branch}`,
              body: `Updates \`${branch}\` to match \`main\`.\n\n**Current ${branch}:** \`${branchSha}\`\n**New (from main):** \`${mainSha}\`\n\nTriggered by @${{ github.actor }} via workflow dispatch.`
            });

            core.summary.addHeading('✅ PR Created', 2);
            core.summary.addRaw(`**PR:** ${pr.html_url}\n\n`);
            core.summary.addRaw(`**Target Branch:** \`${branch}\`\n`);
            await core.summary.write();
