parameters:
  - name: "matrix"
    type: object
    default:
      Windows:
        vmImage: windows-latest
      Linux:
        vmImage: ubuntu-latest
      macOS:
        vmImage: macOS-latest

  - name: "jobs"
    type: object
    default:
      - name: $(Build.Repository.Name)
        working_directory: .

jobs:
  - ${{ each job in parameters.jobs }}:
      - job: ${{ job.name }}
        pool:
          vmImage: $(vmImage)
        steps:
          - template: ./templates/setup.yml
            parameters:
              working_directory: ${{ job.working_directory }}
          - template: ./templates/build.yml
            parameters:
              working_directory: ${{ job.working_directory }}
          - template: ./templates/package.yml
            parameters:
              artifact_name: ${{ job.name }}
              working_directory: ${{ job.working_directory }}
          - template: ./templates/test.yml
            parameters:
              working_directory: ${{ job.working_directory }}
          - template: ./compliance/antimalware.yml
            parameters:
              working_directory: ${{ job.working_directory }}
        variables:
          Codeql.Enabled: $[and(in(variables['Build.Reason'], 'Schedule'), eq(variables['Agent.OS'], 'Linux'))] # Enable CodeQL only on Linux+scheduled builds because it is slow
        strategy:
          matrix: ${{ parameters.matrix }}

  - job: Compliance
    pool:
      vmImage: $(vmImage)
    steps:
      - template: ./compliance/compliance.yml
    strategy:
      matrix: ${{ parameters.matrix }}
    # condition: in(variables['Build.Reason'], 'Schedule', 'IndividualCI') TODO
