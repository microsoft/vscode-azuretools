parameters:
  - name: "jobName"
    type: string
  - name: "vmImage"
    type: string
  - name: "working_directories"
    type: object

jobs:
  - job: ${{ parameters.jobName }}
    pool:
      vmImage: ${{ parameters.vmImage }}
    steps:
      - template: ./templates/setup.yml
      - template: ./templates/build.yml
      - template: ./templates/test.yml
      - template: ./templates/package.yml
    variables:
      Codeql.Enabled: $[and(in(variables['Build.Reason'], 'Schedule'), eq(variables['Agent.OS'], 'Linux'))] # Enable CodeQL only on Linux+scheduled builds because it is slow
    strategy:
      matrix:
        ${{ each working_directory in parameters.working_directories }}:
          ${{ working_directory }}:
            working_directory: ${{ working_directory }}
            artifact_name: ${{ working_directory }}

  - job: ${{ parameters.jobName}}_Compliance
    dependsOn: ${{ parameters.jobName }}
    pool:
      vmImage: ${{ parameters.vmImage }}
    steps:
      - template: ./compliance/compliance.yml
    # condition: or(in(variables['Build.Reason'], 'Manual', 'Schedule'), eq(variables['EnableCompliance'], 'true')) TODO
    variables:
      Codeql.Enabled: $[and(in(variables['Build.Reason'], 'Schedule'), eq(variables['Agent.OS'], 'Linux'))] # Enable CodeQL only on Linux+scheduled builds because it is slow

