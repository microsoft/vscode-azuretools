parameters:
  # Set to enable tests with Azure federated credentials
  - name: testServiceConnection
    type: string

steps:
  - bash: |
      /usr/bin/Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
    displayName: "\U0001F449 Start X Virtual Frame Buffer"
    condition: and(succeeded(), eq(variables['Agent.OS'], 'Linux'))

  - ${{ if ne(parameters.testServiceConnection, '') }}:
      - task: AzureCLI@2
        displayName: "\U0001F449 Verify test service connection"
        inputs:
          azureSubscription: ${{ parameters.testServiceConnection }}
          scriptType: pscore
          scriptLocation: inlineScript
          addSpnToEnvironment: true
          inlineScript: |
            Write-Host "##vso[task.setvariable variable=FC_SERVICE_CONNECTION_CLIENT_ID]$env:servicePrincipalId"
            Write-Host "##vso[task.setvariable variable=FC_SERVICE_CONNECTION_TENANT_ID]$env:tenantId"
            Write-Output "Client ID = $($env:servicePrincipalId)"
            Write-Output "Tenant ID = $($env:tenantId)"

            Write-Output "Maybe SC ID: $($env:AZURESUBSCRIPTION_SERVICE_CONNECTION_ID)"
            Write-Output "Maybe Client ID: $($env:AZURESUBSCRIPTION_CLIENT_ID)"
            Write-Output "Maybe Tenant ID: $($env:AZURESUBSCRIPTION_TENANT_ID)"

            $oidcUri = "$(System.OidcRequestUri)?api-version=7.1&serviceConnectionId=${{ parameters.testServiceConnection }}"
            Write-Output "OIDC URI: $oidcUri"
            $headers = @{
                Authorization = "Bearer $($env:SYSTEM_ACCESSTOKEN)"
                "Content-Type" = "application/json"
                "X-TFS-FedAuthRedirect" = "Suppress"
            }

            $response = Invoke-RestMethod -Uri $oidcUri -Headers $headers -Method Post

            if ($response.oidcToken) {
              Write-Output "oidcToken present and has value, attempting login..."
              & az login --service-principal -u $env:servicePrincipalId --tenant $env:tenantId --federated-token $response.oidcToken --allow-no-subscriptions
            } else {
              Write-Output "oidcToken is null or empty"
            }

            & npm i @azure/identity@latest

            # Verify AzurePipelinesCredential can authenticate
            $nodeScript = @"
            const { AzurePipelinesCredential } = require('@azure/identity');
            const { setLogLevel } = require('@azure/logger');
            setLogLevel('verbose');

            console.log('Creating AzurePipelinesCredential with:');
            console.log('  Tenant ID: ' + process.env.tenantId);
            console.log('  Client ID: ' + process.env.servicePrincipalId);
            console.log('  Service Connection Name: ' + '${{ parameters.testServiceConnection }}');
            const credential = new AzurePipelinesCredential(
              process.env.tenantId,
              process.env.servicePrincipalId,
              '7eed1dc7-f1c5-4076-ad61-f03e3b7d6ec3',
              process.env.SYSTEM_ACCESSTOKEN
            );
            const credential2 = new AzurePipelinesCredential(
              process.env.tenantId,
              process.env.servicePrincipalId,
              '${{ parameters.testServiceConnection }}',
              process.env.SYSTEM_ACCESSTOKEN
            );

            console.log('Requesting token for ARM scope...');

            credential.getToken('https://management.azure.com/.default').then(token => {
              if (token && token.token) {
                console.log('✓ c1: Successfully obtained AzurePipelinesCredential token');
              } else {
                console.error('✗ c1: Token is empty or undefined');
              }
              return credential2.getToken('https://management.azure.com/.default');
            }).then(token => {
              if (token && token.token) {
                console.log('✓ c2: Successfully obtained AzurePipelinesCredential token');
              } else {
                console.error('✗ c2: Token is empty or undefined');
              }
            }).catch(err => {
              console.error('✗ c2: Failed to get token:', err.message);
            });
            "@

            & node -e $nodeScript
        env:
          SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  - task: Npm@1
    displayName: "\U0001F449 Test"
    inputs:
      command: custom
      customCommand: run test
      workingDir: $(working_directory)
    env:
      DISPLAY: :99 # Only necessary for Linux tests, must match Xvfb display number set above
      ${{ if ne(parameters.testServiceConnection, '') }}:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
        FC_SERVICE_CONNECTION_NAME: ${{ parameters.testServiceConnection }}
        FC_SERVICE_CONNECTION_ID: ${{ parameters.testServiceConnection }}
        FC_SERVICE_CONNECTION_CLIENT_ID: $(FC_SERVICE_CONNECTION_CLIENT_ID)
        FC_SERVICE_CONNECTION_TENANT_ID: $(FC_SERVICE_CONNECTION_TENANT_ID)
