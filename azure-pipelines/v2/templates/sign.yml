steps:
  - template: ./find-vsixs.yml

  - pwsh: |
      $vsixList = '$(vsixListJson)' | ConvertFrom-Json

      foreach ($vsix in $vsixList) {
          Write-Output "Signing: $($vsix.vsixName)"
          Set-Location $vsix.directory

          # Generate manifest
          Write-Output "  Generating manifest..."
          & npx @vscode/vsce@latest generate-manifest -i $vsix.vsixName -o $vsix.manifestName
          if ($LASTEXITCODE -ne 0) {
              Write-Error "  Failed to generate manifest for $($vsix.vsixName)"
              exit 1
          }

          # Sign with MSBuild
          Write-Output "  Signing with MSBuild..."
          & dotnet build "$(Agent.BuildDirectory)/s/azExtTemplates/azure-pipelines/v2/static/SignExtension.signproj" /p:ManifestName="$($vsix.manifestName)" /p:SignatureName="$($vsix.signatureName)"
          if ($LASTEXITCODE -ne 0) {
              Write-Error "  Failed to sign $($vsix.vsixName)"
              exit 1
          }

          # Verify signature file was created correctly
          Write-Output "  Verifying signature..."
          & npx @vscode/vsce@latest verify-signature -i $vsix.vsixPath -m $vsix.manifestName -s $vsix.signaturePath
          if ($LASTEXITCODE -ne 0) {
              Write-Error "  Signature verification failed for $($vsix.vsixName)"
              exit 1
          }

          Write-Output "  Successfully signed: $($vsix.vsixName)"
      }
    condition: succeeded()
    displayName: "\U0001F449 Sign all discovered .vsix files"
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
