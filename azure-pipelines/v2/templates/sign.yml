steps:
  - task: UseDotNet@2
    displayName: "\U0001F449 Install .NET Runtime"
    condition: succeeded()
    inputs:
      packageType: runtime

  - task: Npm@1
    displayName: "\U0001F449 Install VSCE"
    condition: succeeded()
    inputs:
      command: custom
      customCommand: install -g @vscode/vsce@latest

  - template: ./find-vsixs.yml

  - pwsh: |
      $vsixList = '$(vsixListJson)' | ConvertFrom-Json

      foreach ($vsix in $vsixList) {
          Set-Location $vsix.directory
          Write-Output "Signing: $($vsix.vsixName)"

          # Generate manifest
          Write-Output "  Generating manifest..."
          & npx @vscode/vsce@latest generate-manifest -i $vsix.vsixName -o $vsix.manifestName
          if ($LASTEXITCODE -ne 0) {
              Write-Error "  Failed to generate manifest for $($vsix.vsixName)"
              exit 1
          }

          # Sign with MicroBuild
          Write-Output "  Signing with MicroBuild..."
          Copy-Item $vsix.manifestName $vsix.signatureName
          & dotnet $($env:MBSIGN_APPFOLDER)/DDSignFiles.dll -- /file:"$($vsix.signatureName)" /certs:4014052
          if ($LASTEXITCODE -ne 0) {
              Write-Error "  Failed to sign $($vsix.vsixName)"
              exit 1
          }

          # Verify signature file was created correctly
          Write-Output "  Verifying signature..."
          & npx @vscode/vsce@latest verify-signature -i $vsix.vsixPath -m $vsix.manifestName -s $vsix.signaturePath
          if ($LASTEXITCODE -ne 0) {
              Write-Error "  Signature verification failed for $($vsix.vsixName)"
              exit 1
          }

          Write-Output "  Successfully signed: $($vsix.vsixName)"
      }
    displayName: "\U0001F449 Sign all discovered .vsix files"
    condition: succeeded()
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
